<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì˜¨ëˆ„ë¦¬ ëŒ€í•™ì²­ë…„ ì „ì„êµì—­ì ë¦¬íŠ¸ë¦¿ ë§ˆë¼í†¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
}
body {
  min-height: 100vh;
  background: radial-gradient(circle at top, #1f2933, #020617 60%);
  color: #f9fafb;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.container {
  width: 100%;
  max-width: 1200px; /* í­ì„ ì¡°ê¸ˆ ë” ë„“í˜ */
  background: rgba(15, 23, 42, 0.92);
  border-radius: 20px;
  padding: 24px 24px 28px;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.55);
  border: 1px solid rgba(148, 163, 184, 0.25);
}
.title {
  text-align: center;
  margin-bottom: 18px;
}
.title h1 {
  font-size: 1.6rem;
  letter-spacing: 0.04em;
  font-weight: 800;
  margin-bottom: 6px;
  line-height: 1.3;
}
.title .accent {
  font-size: 0.9rem;
  color: #38bdf8;
  letter-spacing: 0.16em;
  text-transform: uppercase;
}
/* ê·¸ë£¹ ì…ë ¥ íŒ¨ë„ ìŠ¤íƒ€ì¼ ë³€ê²½ */
.group-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4ê°œ ê·¸ë£¹ ë‚˜ë€íˆ */
  gap: 12px;
  margin-bottom: 18px;
}
@media (max-width: 900px) {
  .group-container {
    grid-template-columns: 1fr 1fr; /* ëª¨ë°”ì¼ì—” 2ì¤„ */
  }
}
@media (max-width: 600px) {
  .group-container {
    grid-template-columns: 1fr; /* ë” ì‘ìœ¼ë©´ 1ì¤„ */
  }
}
.group-box {
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
}
.group-title {
  font-size: 0.95rem;
  font-weight: 700;
  color: #38bdf8;
  margin-bottom: 8px;
  text-align: center;
}
.group-box textarea {
  width: 100%;
  height: 80px;
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid rgba(148, 163, 184, 0.3);
  border-radius: 8px;
  padding: 8px;
  color: #e5e7eb;
  font-size: 0.85rem;
  resize: none;
  margin-bottom: 8px;
}
.group-box textarea:focus {
  border-color: #38bdf8;
  outline: none;
}
.group-file-btn {
    font-size: 0.75rem;
    color: #cbd5e1;
    overflow: hidden;
}
.group-file-btn input[type="file"] {
    width: 100%;
    font-size: 0.75rem;
}

.control-panel {
  margin-bottom: 10px;
}
.hint {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 4px;
  text-align: center;
  margin-bottom: 10px;
}

/* ìš°ì¸¡ ì˜µì…˜ íŒ¨ë„ ë“± (í•˜ë‹¨ ë°°ì¹˜ë¡œ ë³€ê²½ ê³ ë ¤í–ˆìœ¼ë‚˜ ê¸°ì¡´ ìœ ì§€) */
.options-panel {
    background: linear-gradient(135deg, rgba(8, 47, 73, 0.8), rgba(15, 23, 42, 0.97));
    border: 1px solid rgba(56, 189, 248, 0.35);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 16px;
}
.mode-options {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  justify-content: center;
}
.mode-pill {
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  padding: 4px 12px;
  font-size: 0.85rem;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(15, 23, 42, 0.8);
  cursor: pointer;
}

#prizeInput {
  width: 100%;
  min-height: 60px;
  background: rgba(15, 23, 42, 0.95);
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  padding: 8px 10px;
  color: #e5e7eb;
  font-size: 0.82rem;
  resize: vertical;
  outline: none;
}

.btn-row {
  display: flex;
  gap: 12px;
  margin-top: 12px;
  justify-content: center;
}
button {
  border: none;
  cursor: pointer;
  border-radius: 999px;
  padding: 12px 24px;
  font-size: 1rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: transform 0.1s;
}
#startBtn {
  background: linear-gradient(135deg, #f97316, #ec4899);
  color: #f9fafb;
  box-shadow: 0 8px 20px rgba(249, 115, 22, 0.45);
  min-width: 200px;
}
#startBtn:hover { transform: scale(1.03); }
#startBtn:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }

#resetBtnSmall {
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: #e5e7eb;
}

/* ë ˆì´ìŠ¤ ì˜ì—­ */
.race-wrapper {
  margin-top: 16px;
  background: rgba(15, 23, 42, 0.96);
  border-radius: 16px;
  padding: 14px;
  border: 1px solid rgba(31, 41, 55, 0.9);
  position: relative;
}
.race-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 0.9rem;
  color: #9ca3af;
}
.race-light {
  display: inline-block;
  width: 10px; height: 10px;
  border-radius: 50%;
  background: #22c55e;
  margin-right: 6px;
  box-shadow: 0 0 8px #22c55e;
}

.race-area {
  position: relative;
  margin-top: 6px;
  padding: 20px 20px 20px 80px; /* ì™¼ìª½ ì—¬ë°± í™•ë³´ */
  border-radius: 18px;
  background: linear-gradient(#064e3b, #065f46);
  border: 2px solid rgba(15, 23, 42, 0.9);
  overflow: hidden;
  min-height: 400px; /* ë†’ì´ ì¦ê°€ */
}
/* íŠ¸ë™ ë¼ì¸ */
.race-area::before {
  content: "";
  position: absolute;
  inset: 10px 100px; /* ê²°ìŠ¹ì„  ìœ„ì¹˜ ê³ ë ¤ */
  background: repeating-linear-gradient(to bottom, transparent, transparent 98px, rgba(255,255,255,0.1) 98px, rgba(255,255,255,0.1) 100px);
  pointer-events: none;
}

.finish-line {
  position: absolute;
  top: 10px; bottom: 10px;
  right: 140px;
  width: 20px;
  background-image: linear-gradient(45deg, #fff 25%, #000 25%, #000 50%, #fff 50%, #fff 75%, #000 75%, #000);
  background-size: 20px 20px;
  z-index: 1;
}
.finish-label {
  position: absolute;
  top: 10px; right: 40px;
  color: #fbbf24;
  font-weight: 800;
  font-size: 1.2rem;
}

.tracks { position: relative; z-index: 2; }
.track-row {
  position: relative;
  height: 100px; /* ì‚¬ì§„ í¬ê¸°ì— ë§ì¶° ë†’ì´ ì¦ê°€ */
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}
.lane-label {
  position: absolute;
  left: -60px;
  width: 32px; height: 32px;
  border-radius: 50%;
  background: #0f172a;
  border: 1px solid #94a3b8;
  display: flex; align-items: center; justify-content: center;
  color: #fff;
  font-size: 0.8rem;
}

/* ë§(ëŸ¬ë„ˆ) ìŠ¤íƒ€ì¼ ìˆ˜ì •: ì‚¬ì§„ í¬ê²Œ */
.horse {
  position: absolute;
  left: 0; top: 50%;
  transform: translate(0, -50%);
  display: flex; align-items: center;
  gap: 8px;
  z-index: 10;
  transition: transform 0.1s linear; /* ë¶€ë“œëŸ¬ìš´ ì´ë™ */
}
.runner-img {
  width: 80px;  /* í¬ê¸° ëŒ€í­ í™•ëŒ€ */
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #f8fafc;
  box-shadow: 0 4px 10px rgba(0,0,0,0.6);
  background: #1e293b;
}
.horse-emoji {
  font-size: 3.5rem; /* ì´ëª¨ì§€ë„ í¬ê²Œ */
}
/* ë‹¬ë¦´ ë•Œ ì´ë¦„ ìˆ¨ê¹€ */
.horse-name { display: none; }

/* íš¨ê³¼ë“¤ */
.horse.boosting .runner-img {
  border-color: #fbbf24;
  box-shadow: 0 0 20px #fbbf24;
}
.horse.boosting::before {
  content: "ğŸ”¥";
  position: absolute;
  left: -30px; top: 50%; transform: translateY(-50%);
  font-size: 2rem;
  animation: boostAni 0.2s infinite;
}
@keyframes boostAni {
  0% { transform: translateY(-50%) scale(1); }
  50% { transform: translateY(-50%) scale(1.2); }
  100% { transform: translateY(-50%) scale(1); }
}

.horse.slipping { opacity: 0.8; }
.horse.slipping::after {
  content: "ğŸŒ";
  position: absolute; top: -30px; left: 20px;
  font-size: 2rem;
  animation: spin 0.5s infinite;
}

.horse.injured { filter: grayscale(0.8); }
.horse.injured::after {
  content: "ğŸ©¹";
  position: absolute; top: -30px; left: 20px;
  font-size: 2rem;
}

/* ê²°ê³¼ì°½ */
.winner-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  backdrop-filter: blur(5px);
}
.hidden { display: none !important; }

.winner-card {
  background: #1e293b;
  border: 2px solid #f97316;
  border-radius: 20px;
  padding: 30px;
  text-align: center;
  max-width: 600px;
  width: 90%;
  box-shadow: 0 0 50px rgba(249, 115, 22, 0.3);
}
.winner-photo img {
  width: 120px; height: 120px;
  border-radius: 50%;
  border: 4px solid #fbbf24;
  margin: 10px 0;
}
.winner-name {
  font-size: 1.8rem;
  font-weight: bold;
  color: #fff;
  margin: 10px 0;
}
.winner-group {
  font-size: 1rem;
  color: #38bdf8;
  margin-bottom: 10px;
}

.rank-list {
  text-align: left;
  background: #0f172a;
  padding: 10px;
  border-radius: 10px;
  margin-top: 10px;
  max-height: 300px;
  overflow-y: auto;
}
.rank-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px;
  border-bottom: 1px solid #334155;
}
.rank-row:last-child { border-bottom: none; }
.rank-info { display: flex; align-items: center; gap: 10px; }
.rank-img-small {
  width: 50px; height: 50px; /* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì‚¬ì§„ë„ í™•ëŒ€ */
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #cbd5e1;
}
.rank-text { display: flex; flex-direction: column; }
.rank-badge { font-weight: bold; color: #fbbf24; font-size: 0.9rem; }
.rank-n { font-size: 1rem; font-weight: 600; }
.rank-g { font-size: 0.8rem; color: #94a3b8; }
.rank-prize { color: #fcd34d; font-size: 0.9rem; text-align: right; max-width: 40%; word-break: keep-all;}

.winner-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
#closeWinnerBtn { background: #22c55e; }
#replayBtn { background: #475569; }
</style>
</head>
<body>

<div id="player" style="display:none;"></div>

<div class="container">
  <div class="title">
    <div class="accent">Random Draw</div>
    <h1>ì˜¨ëˆ„ë¦¬ ëŒ€í•™ì²­ë…„ ì „ì„êµì—­ì<br />ë¦¬íŠ¸ë¦¿ ë§ˆë¼í†¤ ğŸƒ</h1>
  </div>

  <div class="group-container">
    <div class="group-box">
      <div class="group-title">ì˜ˆë°°ê¸°íš</div>
      <textarea id="namesGroup1" placeholder="ì´ë¦„ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)"></textarea>
      <div class="group-file-btn">
        ì‚¬ì§„: <input type="file" id="filesGroup1" accept="image/*" multiple>
      </div>
    </div>
    <div class="group-box">
      <div class="group-title">ì„ êµ</div>
      <textarea id="namesGroup2" placeholder="ì´ë¦„ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)"></textarea>
      <div class="group-file-btn">
        ì‚¬ì§„: <input type="file" id="filesGroup2" accept="image/*" multiple>
      </div>
    </div>
    <div class="group-box">
      <div class="group-title">ì–‘ìœ¡</div>
      <textarea id="namesGroup3" placeholder="ì´ë¦„ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)"></textarea>
      <div class="group-file-btn">
        ì‚¬ì§„: <input type="file" id="filesGroup3" accept="image/*" multiple>
      </div>
    </div>
    <div class="group-box">
      <div class="group-title">ì‚¬ì—­ìº í¼ìŠ¤</div>
      <textarea id="namesGroup4" placeholder="ì´ë¦„ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)"></textarea>
      <div class="group-file-btn">
        ì‚¬ì§„: <input type="file" id="filesGroup4" accept="image/*" multiple>
      </div>
      <div style="font-size:0.7rem; color:#fbbf24; margin-top:4px;">â€» ë„ì°© ì‹œ í•­ëª© 2ê°œ ë§¤ì¹­!</div>
    </div>
  </div>

  <div class="options-panel">
    <div class="mode-options">
      <label class="mode-pill">
        <input type="radio" name="mode" value="rank" checked /> ìˆœìœ„ë§Œ ë³´ê¸°
      </label>
      <label class="mode-pill">
        <input type="radio" name="mode" value="match" /> ê²°ìŠ¹ì„  í•­ëª© ëœë¤ ë§¤ì¹­
      </label>
    </div>
    
    <div id="prizeWrapper" class="hidden">
      <div class="hint">ê²°ìŠ¹ì„  í•­ëª©(ìƒí’ˆ/ë²Œì¹™)ì„ ì…ë ¥í•˜ì„¸ìš” (5ê°œ ì´ìƒ ê¶Œì¥)</div>
      <textarea id="prizeInput" placeholder="ì˜ˆì‹œ)&#10;ìŠ¤íƒ€ë²…ìŠ¤ìƒí’ˆê¶Œ&#10;ì„¤ê±°ì§€&#10;ì•ˆë§ˆí•´ì£¼ê¸°&#10;ì˜í™”ì˜ˆë§¤ê¶Œ&#10;ì¹­ì°¬í•˜ê¸°"></textarea>
    </div>
  </div>

  <div class="btn-row">
    <button id="startBtn">ë ˆì´ìŠ¤ ì‹œì‘! ğŸ</button>
    <button id="resetBtnSmall">ì´ˆê¸°í™”</button>
  </div>

  <div class="race-wrapper">
    <div class="race-header">
      <div><span class="race-light" id="raceStatusLight"></span> <span id="raceStatusText">ëŒ€ê¸° ì¤‘...</span></div>
      <div>ê²°ìŠ¹ì„  í†µê³¼ ìˆœì„œëŒ€ë¡œ 1~4ë“± ê²°ì •</div>
    </div>
    <div class="race-area" id="raceArea">
      <div class="finish-line"></div>
      <div class="finish-label">FINISH</div>
      <div class="tracks" id="tracks"></div>
    </div>
  </div>
</div>

<div class="winner-overlay hidden" id="winnerOverlay">
  <div class="winner-card">
    <div class="winner-icon">ğŸ†</div>
    <div id="winnerPhoto" class="winner-photo"></div>
    <div class="winner-group" id="winnerGroup"></div>
    <div class="winner-name" id="winnerName">1ë“± ì´ë¦„</div>
    <div class="winner-sub" id="winnerSub"></div>
    <div id="rankList" class="rank-list"></div>
    <div class="winner-buttons">
      <button id="closeWinnerBtn">ë‹«ê¸°</button>
      <button id="replayBtn">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
// --- ì „ì—­ ë³€ìˆ˜ ---
let horses = [];
let raceRunning = false;
let animationFrameId = null;
let finishedOrder = [];
let imageBlobUrls = []; // ìƒì„±ëœ blob URL ê´€ë¦¬ (ë©”ëª¨ë¦¬ í•´ì œìš©)
let youtubePlayer = null; // ìœ íŠœë¸Œ í”Œë ˆì´ì–´ ê°ì²´

// --- ê·¸ë£¹ ì •ì˜ ---
const GROUPS = [
  { id: 'Group1', name: 'ì˜ˆë°°ê¸°íš', elName: 'namesGroup1', elFile: 'filesGroup1' },
  { id: 'Group2', name: 'ì„ êµ',     elName: 'namesGroup2', elFile: 'filesGroup2' },
  { id: 'Group3', name: 'ì–‘ìœ¡',     elName: 'namesGroup3', elFile: 'filesGroup3' },
  { id: 'Group4', name: 'ì‚¬ì—­ìº í¼ìŠ¤', elName: 'namesGroup4', elFile: 'filesGroup4' }
];

// --- DOM ìš”ì†Œ ---
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtnSmall");
const tracksEl = document.getElementById("tracks");
const modeRadios = document.querySelectorAll('input[name="mode"]');
const prizeWrapper = document.getElementById("prizeWrapper");
const prizeInput = document.getElementById("prizeInput");
const winnerOverlay = document.getElementById("winnerOverlay");

// --- ìœ íŠœë¸Œ API ë¡œë“œ ---
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
const firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
  youtubePlayer = new YT.Player('player', {
    height: '0',
    width: '0',
    videoId: 'ZzHYbM0l4ec', // ë¶ˆì˜ ì „ì°¨ OST
    events: {
      'onReady': onPlayerReady
    }
  });
}
function onPlayerReady(event) {
  // ì¤€ë¹„ ì™„ë£Œ
}
function playMusic() {
  if(youtubePlayer && youtubePlayer.playVideo) {
    youtubePlayer.seekTo(0);
    youtubePlayer.playVideo();
  }
}
function stopMusic() {
  if(youtubePlayer && youtubePlayer.stopVideo) {
    youtubePlayer.stopVideo();
  }
}

// --- ëª¨ë“œ ë³€ê²½ í•¸ë“¤ëŸ¬ ---
modeRadios.forEach(r => {
  r.addEventListener('change', () => {
    prizeWrapper.classList.toggle('hidden', r.value !== 'match');
  });
});

// --- í—¬í¼ í•¨ìˆ˜ ---
function parseLines(val) {
  return val.trim().split('\n').map(s=>s.trim()).filter(s=>s.length>0);
}

// 4ê°œ ê·¸ë£¹ì—ì„œ ë°ì´í„° ìˆ˜ì§‘í•˜ì—¬ 'horses' ë°°ì—´ ìƒì„±
function setupHorses() {
  // ê¸°ì¡´ ì´ë¯¸ì§€ URL í•´ì œ
  imageBlobUrls.forEach(url => URL.revokeObjectURL(url));
  imageBlobUrls = [];
  horses = [];
  tracksEl.innerHTML = "";

  let totalIndex = 0;

  GROUPS.forEach(groupInfo => {
    const nameEl = document.getElementById(groupInfo.elName);
    const fileEl = document.getElementById(groupInfo.elFile);
    
    const names = parseLines(nameEl.value);
    const files = fileEl.files;

    names.forEach((name, idx) => {
      let imgUrl = null;
      if(files && files[idx]) {
        imgUrl = URL.createObjectURL(files[idx]);
        imageBlobUrls.push(imgUrl);
      }

      // DOM ìƒì„±
      const row = document.createElement("div");
      row.className = "track-row";
      
      const laneLabel = document.createElement("div");
      laneLabel.className = "lane-label";
      laneLabel.textContent = totalIndex + 1;
      
      const horseEl = document.createElement("div");
      horseEl.className = "horse";
      
      if(imgUrl) {
        const img = document.createElement("img");
        img.className = "runner-img";
        img.src = imgUrl;
        horseEl.appendChild(img);
      } else {
        const emoji = document.createElement("div");
        emoji.className = "horse-emoji";
        emoji.textContent = "ğŸƒ"; // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ëª¨ì§€
        horseEl.appendChild(emoji);
      }
      
      // ì´ë¦„ì€ DOMì— ë¶™ì—¬ë‘ë˜ CSSë¡œ ìˆ¨ê¹€
      const nameSpan = document.createElement("span");
      nameSpan.className = "horse-name";
      nameSpan.textContent = name;
      horseEl.appendChild(nameSpan);

      row.appendChild(laneLabel);
      row.appendChild(horseEl);
      tracksEl.appendChild(row);

      // ë ˆì´ìŠ¤ ë¡œì§ìš© ê°ì²´ ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜ íŒŒë¼ë¯¸í„° ì¡°ì •)
      // ë¶€ìŠ¤í„° íŠ¸ë¦¬ê±° ë“± ëœë¤ ì„¤ì •
      const triggerCount = 2 + Math.floor(Math.random() * 2);
      const triggers = [];
      for(let i=0; i<triggerCount; i++) triggers.push(Math.random()*0.8 + 0.1);
      
      horses.push({
        el: horseEl,
        rowEl: row,
        name: name,
        groupName: groupInfo.name, // ê·¸ë£¹ëª… ì €ì¥
        imgUrl: imgUrl,
        x: 0,
        baseSpeed: 60 + Math.random() * 30, // ì†ë„ ë³€ìˆ˜
        finished: false,
        boostTriggers: triggers.sort((a,b)=>a-b),
        isBoosting: false,
        boostTime: 0,
        injuryTrigger: 0.3 + Math.random() * 0.4,
        isInjured: false,
        injuryTime: 0,
        injuryUsed: false,
        bananaTrigger: 0.2 + Math.random() * 0.5,
        bananaUsed: false,
        isSlipping: false,
        slipTime: 0,
        // ë§‰íŒ ë’¤ì§‘ê¸°
        finalDrama: Math.random() > 0.5 ? 'boost' : 'injury',
        finalDramaTrigger: 0.85 + Math.random() * 0.05,
        finalDramaUsed: false
      });
      
      totalIndex++;
    });
  });
}

// --- ë ˆì´ìŠ¤ ë¡œì§ ---
function startRace() {
  setupHorses();
  if (horses.length < 2) {
    alert("ìµœì†Œ 2ëª… ì´ìƒì˜ ëŸ¬ë„ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }
  const mode = document.querySelector('input[name="mode"]:checked').value;
  if(mode === 'match') {
    const p = parseLines(prizeInput.value);
    if(p.length < 1) {
      alert("ê²°ìŠ¹ì„  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
  }

  // UI ì ê¸ˆ
  startBtn.disabled = true;
  resetBtn.disabled = true;
  GROUPS.forEach(g => {
    document.getElementById(g.elName).disabled = true;
    document.getElementById(g.elFile).disabled = true;
  });
  winnerOverlay.classList.add("hidden");
  
  playMusic(); // ìŒì•… ì¬ìƒ

  raceRunning = true;
  finishedOrder = [];
  lastTime = null;
  
  document.getElementById("raceStatusLight").style.background = "#facc15";
  document.getElementById("raceStatusText").textContent = "ë ˆì´ìŠ¤ ì§„í–‰ ì¤‘! ğŸƒâ€â™‚ï¸ğŸƒâ€â™€ï¸";

  requestAnimationFrame(loop);
}

let lastTime = null;
const finishX = document.getElementById("raceArea").clientWidth - 180; // ì—¬ë°± ê³ ë ¤

function loop(timestamp) {
  if(!raceRunning) return;
  if(!lastTime) lastTime = timestamp;
  const delta = timestamp - lastTime;
  lastTime = timestamp;

  // í˜„ì¬ ì„ ë‘ì™€ ê¼´ì°Œ ê±°ë¦¬ ê³„ì‚° (ê³ ë¬´ì¤„ íš¨ê³¼ìš©)
  const xs = horses.map(h => h.x);
  const minX = Math.min(...xs);
  const maxX = Math.max(...xs);
  const dist = maxX - minX || 1;

  horses.forEach(h => {
    if(h.finished) return;

    let speed = h.baseSpeed * (0.9 + Math.random()*0.2); // ê¸°ë³¸ ë³€ë™
    
    // ê³ ë¬´ì¤„ íš¨ê³¼ (ë’¤ì²˜ì§€ë©´ ë¹¨ë¼ì§)
    const relPos = (h.x - minX) / dist; // 0(ë’¤) ~ 1(ì•)
    speed *= (1.4 - relPos * 0.6); 

    const progress = h.x / finishX;

    // ìƒíƒœ ê´€ë¦¬: ë¯¸ë„ëŸ¬ì§(ë°”ë‚˜ë‚˜)
    if(h.isSlipping) {
      speed = -20; // ë’¤ë¡œ ë°€ë¦¼
      h.slipTime -= delta;
      if(h.slipTime <= 0) {
        h.isSlipping = false;
        h.el.classList.remove("slipping");
      }
    }
    // ìƒíƒœ ê´€ë¦¬: ë¶€ìƒ
    else if(h.isInjured) {
      speed *= 0.1;
      h.injuryTime -= delta;
      if(h.injuryTime <= 0) {
        h.isInjured = false;
        h.el.classList.remove("injured");
      }
    }
    // ìƒíƒœ ê´€ë¦¬: ë¶€ìŠ¤í„°
    else if(h.isBoosting) {
      speed *= 4.5;
      h.boostTime -= delta;
      if(h.boostTime <= 0) {
        h.isBoosting = false;
        h.el.classList.remove("boosting");
      }
    }
    // ì¼ë°˜ ì£¼í–‰ ì¤‘ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
    else {
      // 1. ë°”ë‚˜ë‚˜ ë˜ì§€ê¸°
      if(!h.bananaUsed && progress > h.bananaTrigger) {
        h.bananaUsed = true;
        // ë‚˜ë³´ë‹¤ ì•ì— ìˆëŠ” ëœë¤ íƒ€ê²Ÿ
        const targets = horses.filter(t => !t.finished && t.x > h.x && t !== h);
        if(targets.length > 0) {
          const target = targets[Math.floor(Math.random()*targets.length)];
          target.isSlipping = true;
          target.slipTime = 800;
          target.isBoosting = false; target.el.classList.remove("boosting");
          target.el.classList.add("slipping");
        }
      }
      // 2. ë¶€ìƒ
      if(!h.injuryUsed && progress > h.injuryTrigger && Math.random() < 0.3) {
        h.injuryUsed = true;
        h.isInjured = true;
        h.injuryTime = 1000;
        h.el.classList.add("injured");
      }
      // 3. ë¶€ìŠ¤í„° ì²´í¬
      if(h.boostTriggers.length > 0 && progress > h.boostTriggers[0]) {
        h.boostTriggers.shift();
        h.isBoosting = true;
        h.boostTime = 800 + Math.random()*400;
        h.el.classList.add("boosting");
      }
      // 4. ë§‰íŒ ë“œë¼ë§ˆ
      if(!h.finalDramaUsed && progress > h.finalDramaTrigger) {
        h.finalDramaUsed = true;
        if(h.finalDrama === 'boost') {
          h.isBoosting = true;
          h.boostTime = 1500;
          h.el.classList.add("boosting");
        } else {
          h.isInjured = true;
          h.injuryTime = 1200;
          h.el.classList.add("injured");
        }
      }
    }

    // ì´ë™
    h.x += (speed * delta) / 1000 * 4.0; // ì†ë„ ë°°ìœ¨

    // ê³¨ì¸ ì²˜ë¦¬
    if(h.x >= finishX) {
      h.x = finishX;
      h.finished = true;
      h.el.classList.remove("boosting", "injured", "slipping");
      finishedOrder.push(h);
      
      // ê²¹ì¹˜ì§€ ì•Šê²Œ ì‹œê°ì  ì˜¤í”„ì…‹
      h.x += (10 - finishedOrder.length) * 5; 
    }

    h.el.style.transform = `translate(${h.x}px, -50%)`;
  });

  // ëª¨ë“  ë§ì´ ë“¤ì–´ì˜¤ê±°ë‚˜, ìƒìœ„ 4ë“±ì´ ì •í•´ì§€ê³  ê¼´ì°Œ ê·¸ë£¹ì´ ë„ˆë¬´ ë©€ë©´ ì¢…ë£Œ ê°€ëŠ¥í•˜ì§€ë§Œ
  // ì—¬ê¸°ì„  ì „ì²´ ì™„ì£¼ í˜¹ì€ 4ë“±ê¹Œì§€ë§Œ ê¸°ë‹¤ë¦¼
  const totalRunners = horses.length;
  const maxWait = Math.min(4, totalRunners);
  
  if(finishedOrder.length >= maxWait) {
    // ì‚´ì§ ë”œë ˆì´ í›„ ê²°ê³¼ì°½
    setTimeout(showResult, 1000);
    raceRunning = false;
    stopMusic(); // ìŒì•… ì •ì§€
  } else {
    animationFrameId = requestAnimationFrame(loop);
  }
}

function showResult() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const prizes = (mode === 'match') ? parseLines(prizeInput.value) : [];
  
  // ì…”í”Œëœ ìƒê¸ˆ í’€ ë§Œë“¤ê¸°
  let prizePool = [];
  if(mode === 'match') {
    // ë„‰ë„‰í•˜ê²Œ ë³µì‚¬í•´ì„œ ì„ìŒ
    let temp = [...prizes, ...prizes, ...prizes]; 
    for(let i=temp.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [temp[i], temp[j]] = [temp[j], temp[i]];
    }
    prizePool = temp;
  }

  const winner = finishedOrder[0];
  document.getElementById("winnerName").textContent = `1ë“±: ${winner.name}`;
  document.getElementById("winnerGroup").textContent = `[${winner.groupName}]`;
  
  const wPhoto = document.getElementById("winnerPhoto");
  wPhoto.innerHTML = "";
  if(winner.imgUrl) {
    const img = document.createElement("img");
    img.src = winner.imgUrl;
    wPhoto.appendChild(img);
  } else {
    wPhoto.innerHTML = "<span style='font-size:4rem'>ğŸƒ</span>";
  }

  // ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ìƒì„±
  const listEl = document.getElementById("rankList");
  listEl.innerHTML = "";
  
  const showCount = Math.min(finishedOrder.length, 4); // 4ë“±ê¹Œì§€ë§Œ í‘œì‹œ
  
  let prizeCursor = 0;

  for(let i=0; i<showCount; i++) {
    const h = finishedOrder[i];
    const row = document.createElement("div");
    row.className = "rank-row";
    
    // ì‚¬ì§„/ì´ëª¨ì§€
    let iconHTML = h.imgUrl 
      ? `<img src="${h.imgUrl}" class="rank-img-small">` 
      : `<span style="font-size:1.5rem; width:50px; text-align:center;">ğŸƒ</span>`;

    // ìƒí’ˆ ë°°ì • ë¡œì§
    let assignedPrize = "";
    if(mode === 'match') {
        // ê¸°ë³¸ 1ê°œ ë½‘ê¸°
        let p1 = prizePool[prizeCursor++] || "ê½";
        assignedPrize = p1;

        // ì‚¬ì—­ìº í¼ìŠ¤ ê·¸ë£¹ íŠ¹ì „: í•˜ë‚˜ ë”!
        if(h.groupName === "ì‚¬ì—­ìº í¼ìŠ¤") {
             let p2 = prizePool[prizeCursor++] || "ê½";
             assignedPrize = `â‘  ${p1}, â‘¡ ${p2}`;
        }
    }

    row.innerHTML = `
      <div class="rank-info">
        ${iconHTML}
        <div class="rank-text">
          <span class="rank-badge">${i+1}ë“±</span>
          <span class="rank-n">${h.name}</span>
          <span class="rank-g">${h.groupName}</span>
        </div>
      </div>
      <div class="rank-prize">${assignedPrize}</div>
    `;
    listEl.appendChild(row);
  }

  winnerOverlay.classList.remove("hidden");
  
  // ë²„íŠ¼ í™œì„±í™” ë³µêµ¬
  startBtn.disabled = false;
  resetBtn.disabled = false;
  GROUPS.forEach(g => {
    document.getElementById(g.elName).disabled = false;
    document.getElementById(g.elFile).disabled = false;
  });
}

// --- ë¦¬ì…‹ ---
function fullReset() {
  stopMusic();
  raceRunning = false;
  cancelAnimationFrame(animationFrameId);
  tracksEl.innerHTML = "";
  horses = [];
  document.getElementById("raceStatusLight").style.background = "#22c55e";
  document.getElementById("raceStatusText").textContent = "ëŒ€ê¸° ì¤‘...";
  
  // ì…ë ¥ê°’ ì´ˆê¸°í™”
  GROUPS.forEach(g => {
    document.getElementById(g.elName).value = "";
    document.getElementById(g.elFile).value = "";
  });
  prizeInput.value = "";
}

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
startBtn.addEventListener("click", startRace);
resetBtn.addEventListener("click", fullReset);
document.getElementById("closeWinnerBtn").addEventListener("click", () => winnerOverlay.classList.add("hidden"));
document.getElementById("replayBtn").addEventListener("click", () => {
  winnerOverlay.classList.add("hidden");
  startRace();
});

</script>
</body>
</html>
