<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì˜¨ëˆ„ë¦¬ ëŒ€í•™ì²­ë…„ ì „ì„êµì—­ì ë¦¬íŠ¸ë¦¿ ë§ˆë¼í†¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
}
body {
  min-height: 100vh;
  background: radial-gradient(circle at top, #1f2933, #020617 60%);
  color: #f9fafb;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.container {
  width: 100%;
  max-width: 1200px;
  background: rgba(15, 23, 42, 0.92);
  border-radius: 20px;
  padding: 24px 24px 28px;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.55);
  border: 1px solid rgba(148, 163, 184, 0.25);
}
.title {
  text-align: center;
  margin-bottom: 24px;
}
.title h1 {
  font-size: 1.8rem;
  font-weight: 800;
  margin-bottom: 6px;
  line-height: 1.3;
}
.title .accent {
  font-size: 0.9rem;
  color: #38bdf8;
  letter-spacing: 0.16em;
  text-transform: uppercase;
}

/* ê³ ì • ëŸ¬ë„ˆ ì„¤ì • ì˜ì—­ */
.fixed-runners {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}
@media (max-width: 800px) {
  .fixed-runners { grid-template-columns: 1fr 1fr; }
}
.runner-card {
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 16px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}
.runner-name-badge {
  font-size: 1.1rem;
  font-weight: 700;
  color: #fff;
  background: #0ea5e9;
  padding: 4px 12px;
  border-radius: 999px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}
/* ì‚¬ì—­ìº í¼ìŠ¤ ê°•ì¡° */
.runner-card.special .runner-name-badge {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}
.file-label {
  font-size: 0.8rem;
  color: #94a3b8;
  margin-bottom: 4px;
  cursor: pointer;
}
.file-input {
  width: 100%;
  font-size: 0.75rem;
  color: #cbd5e1;
}
.special-note {
  font-size: 0.75rem;
  color: #fbbf24;
  margin-top: 8px;
  font-weight: 600;
}

/* ì˜µì…˜ ë° ë²„íŠ¼ */
.control-area {
  display: flex;
  flex-direction: column;
  gap: 16px;
  align-items: center;
  margin-bottom: 20px;
}
.mode-options {
  display: flex;
  gap: 12px;
}
.mode-pill {
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.5);
  padding: 6px 16px;
  font-size: 0.9rem;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(15, 23, 42, 0.6);
  cursor: pointer;
}
#prizeWrapper {
  width: 100%;
  max-width: 600px;
  text-align: center;
}
#prizeInput {
  width: 100%;
  height: 60px;
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid rgba(148, 163, 184, 0.4);
  border-radius: 8px;
  padding: 8px;
  color: #fff;
  resize: vertical;
}

.btn-row {
  display: flex;
  gap: 16px;
}
button {
  border: none;
  cursor: pointer;
  border-radius: 999px;
  padding: 14px 32px;
  font-size: 1.1rem;
  font-weight: 800;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}
#startBtn {
  background: linear-gradient(135deg, #f97316, #ec4899);
  color: #fff;
  box-shadow: 0 8px 25px rgba(249, 115, 22, 0.5);
}
#startBtn:hover { transform: scale(1.05); }
#startBtn:disabled { filter: grayscale(1); cursor: not-allowed; transform: none; }
#resetBtn {
  background: #334155;
  color: #e2e8f0;
}

/* ë ˆì´ìŠ¤ ì˜ì—­ */
.race-wrapper {
  margin-top: 10px;
  background: rgba(15, 23, 42, 0.96);
  border-radius: 16px;
  padding: 14px;
  border: 1px solid rgba(56, 189, 248, 0.2);
  position: relative;
}
.race-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 0.9rem;
  color: #9ca3af;
}
.race-area {
  position: relative;
  margin-top: 6px;
  padding: 20px 0; /* ìƒí•˜ ì—¬ë°± */
  border-radius: 18px;
  background: linear-gradient(#064e3b, #065f46); /* ì”ë””ìƒ‰ */
  border: 4px solid #0f172a;
  overflow: hidden;
  height: 480px; /* íŠ¸ë™ ë†’ì´ ì¶©ë¶„íˆ í™•ë³´ */
}
/* íŠ¸ë™ ë¼ì¸ */
.race-area::before {
  content: "";
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(to bottom, transparent, transparent 118px, rgba(255,255,255,0.1) 118px, rgba(255,255,255,0.1) 120px);
  pointer-events: none;
}

.finish-line {
  position: absolute;
  top: 0; bottom: 0;
  right: 120px;
  width: 24px;
  background-image: linear-gradient(45deg, #fff 25%, #000 25%, #000 50%, #fff 50%, #fff 75%, #000 75%, #000);
  background-size: 24px 24px;
  z-index: 1;
}
.finish-label {
  position: absolute;
  top: 10px; right: 20px;
  color: #fbbf24;
  font-weight: 900;
  font-size: 1.5rem;
  transform: rotate(90deg);
  transform-origin: right top;
}

.tracks {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: space-evenly; /* ê· ë“± ë°°ë¶„ */
}

/* ë§(ëŸ¬ë„ˆ) ìŠ¤íƒ€ì¼ */
.horse {
  position: absolute;
  left: 20px; /* ì¶œë°œì„  */
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 10;
  transition: transform 0.05s linear; /* ë¶€ë“œëŸ¬ìš´ ì´ë™ */
  will-change: transform;
}
.runner-img {
  width: 80px;  /* ì‚¬ì§„ í¬ê¸° 80px ìœ ì§€ */
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #f8fafc;
  box-shadow: 0 4px 15px rgba(0,0,0,0.7);
  background: #1e293b;
}
.horse-emoji {
  font-size: 4rem;
  line-height: 1;
  filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
}

/* ìƒíƒœ ì´í™íŠ¸ */
.horse.boosting .runner-img { border-color: #facc15; box-shadow: 0 0 25px #facc15; }
.horse.boosting::before {
  content: "ğŸ”¥"; position: absolute; left: -40px; top: 50%; transform: translateY(-50%); font-size: 2.5rem;
  animation: bounce 0.3s infinite alternate;
}
.horse.injured { filter: grayscale(1); opacity: 0.7; }
.horse.injured::after {
  content: "ğŸ©¹"; position: absolute; top: -30px; left: 20px; font-size: 2rem;
}
.horse.slipping { opacity: 0.8; }
.horse.slipping::after {
  content: "ğŸŒ"; position: absolute; top: -30px; left: 20px; font-size: 2rem; animation: spin 0.5s infinite;
}
@keyframes bounce { to { transform: translateY(-55%); } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* ê²°ê³¼ì°½ */
.winner-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  backdrop-filter: blur(8px);
}
.hidden { display: none !important; }

.winner-card {
  background: #1e293b;
  border: 2px solid #f97316;
  border-radius: 20px;
  padding: 30px;
  text-align: center;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 0 60px rgba(249, 115, 22, 0.4);
}
.winner-photo img {
  width: 140px; height: 140px;
  border-radius: 50%;
  border: 5px solid #fbbf24;
  margin: 10px 0;
  object-fit: cover;
}
.winner-name { font-size: 2rem; font-weight: bold; color: #fff; margin: 10px 0; }
.rank-list { text-align: left; background: #0f172a; padding: 12px; border-radius: 12px; margin-top: 16px; }
.rank-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #334155; }
.rank-row:last-child { border-bottom: none; }
.rank-left { display: flex; align-items: center; gap: 10px; }
.rank-badge { color: #fbbf24; font-weight: bold; width: 40px; }
.rank-txt { font-weight: 600; color: #e2e8f0; }
.rank-prize { font-size: 0.9rem; color: #fcd34d; text-align: right; width: 50%; }

</style>
</head>
<body>

<div id="player" style="display:none;"></div>

<div class="container">
  <div class="title">
    <div class="accent">Retreat Event</div>
    <h1>ì „ì„êµì—­ì ë¦¬íŠ¸ë¦¿ ë§ˆë¼í†¤ ğŸƒ</h1>
  </div>

  <div class="fixed-runners">
    <div class="runner-card">
      <div class="runner-name-badge">1. ì˜ˆë°°ê¸°íš</div>
      <label class="file-label">ğŸ“¸ ì‚¬ì§„ ì„ íƒ:</label>
      <input type="file" id="file0" class="file-input" accept="image/*">
    </div>
    <div class="runner-card">
      <div class="runner-name-badge">2. ì„ êµ</div>
      <label class="file-label">ğŸ“¸ ì‚¬ì§„ ì„ íƒ:</label>
      <input type="file" id="file1" class="file-input" accept="image/*">
    </div>
    <div class="runner-card">
      <div class="runner-name-badge">3. ì–‘ìœ¡</div>
      <label class="file-label">ğŸ“¸ ì‚¬ì§„ ì„ íƒ:</label>
      <input type="file" id="file2" class="file-input" accept="image/*">
    </div>
    <div class="runner-card special">
      <div class="runner-name-badge">4. ì‚¬ì—­ìº í¼ìŠ¤</div>
      <label class="file-label">ğŸ“¸ ì‚¬ì§„ ì„ íƒ:</label>
      <input type="file" id="file3" class="file-input" accept="image/*">
      <div class="special-note">ğŸ ë„ì°© ì‹œ í•­ëª© 2ê°œ íšë“!</div>
    </div>
  </div>

  <div class="control-area">
    <div class="mode-options">
      <label class="mode-pill">
        <input type="radio" name="mode" value="rank" checked /> ìˆœìœ„ë§Œ ë³´ê¸°
      </label>
      <label class="mode-pill">
        <input type="radio" name="mode" value="match" /> ìƒí’ˆ/ë²Œì¹™ ë§¤ì¹­
      </label>
    </div>
    <div id="prizeWrapper" class="hidden">
      <textarea id="prizeInput" placeholder="ê²°ìŠ¹ì„  í•­ëª© ì…ë ¥ (ì˜ˆ: ì„¤ê±°ì§€, ì»¤í”¼ì˜ê¸°, ì¹­ì°¬í•˜ê¸° - ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
    </div>
    <div class="btn-row">
      <button id="startBtn">ë ˆì´ìŠ¤ ì‹œì‘! ğŸ</button>
      <button id="resetBtn">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="race-wrapper">
    <div class="race-header">
      <span id="raceStatus">ëŒ€ê¸° ì¤‘...</span>
      <span>ê²°ìŠ¹ì„  í†µê³¼ ìˆœì„œëŒ€ë¡œ ê²°ì •</span>
    </div>
    <div class="race-area" id="raceArea">
      <div class="finish-line"></div>
      <div class="finish-label">FINISH</div>
      <div class="tracks" id="tracks"></div>
    </div>
  </div>
</div>

<div class="winner-overlay hidden" id="winnerOverlay">
  <div class="winner-card">
    <div>ğŸ† Result</div>
    <div id="winnerPhoto" class="winner-photo"></div>
    <div class="winner-name" id="winnerName"></div>
    <div id="rankList" class="rank-list"></div>
    <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
      <button id="closeBtn" style="padding:10px 20px; font-size:0.9rem; background:#475569;">ë‹«ê¸°</button>
      <button id="replayBtn" style="padding:10px 20px; font-size:0.9rem; background:#0ea5e9;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
// --- ì „ì—­ ì„¤ì • ---
const FIXED_NAMES = ["ì˜ˆë°°ê¸°íš", "ì„ êµ", "ì–‘ìœ¡", "ì‚¬ì—­ìº í¼ìŠ¤"];
let horses = [];
let raceRunning = false;
let animationFrameId = null;
let finishedOrder = [];
let imgBlobs = [];
let youtubePlayer = null;

// --- ìœ íŠœë¸Œ BGM ì„¤ì • ---
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
const firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
  youtubePlayer = new YT.Player('player', {
    height: '0', width: '0',
    videoId: 'ZzHYbM0l4ec', // ë¶ˆì˜ ì „ì°¨
  });
}
function playMusic() { if(youtubePlayer?.playVideo) { youtubePlayer.seekTo(0); youtubePlayer.playVideo(); } }
function stopMusic() { if(youtubePlayer?.stopVideo) youtubePlayer.stopVideo(); }

// --- DOM ---
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const tracksEl = document.getElementById("tracks");
const winnerOverlay = document.getElementById("winnerOverlay");
const prizeWrapper = document.getElementById("prizeWrapper");
const prizeInput = document.getElementById("prizeInput");
const modeRadios = document.querySelectorAll('input[name="mode"]');

// ëª¨ë“œ í† ê¸€
modeRadios.forEach(r => r.addEventListener('change', () => {
  prizeWrapper.classList.toggle('hidden', r.value !== 'match');
}));

// ì¤„ë°”ê¿ˆ íŒŒì‹±
function parseLines(v) { return v.trim().split('\n').map(s=>s.trim()).filter(s=>s.length>0); }

// --- ì´ˆê¸°í™” ë° ë§ ì„¸íŒ… ---
function setupRace() {
  // ê¸°ì¡´ ë°ì´í„° ì •ë¦¬
  imgBlobs.forEach(url => URL.revokeObjectURL(url));
  imgBlobs = [];
  horses = [];
  finishedOrder = [];
  tracksEl.innerHTML = "";
  
  // 4ê°œ ê³ ì • ëŸ¬ë„ˆ ìƒì„±
  FIXED_NAMES.forEach((name, idx) => {
    // íŒŒì¼ í™•ì¸
    const fileInput = document.getElementById(`file${idx}`);
    let imgUrl = null;
    if(fileInput.files && fileInput.files[0]) {
      imgUrl = URL.createObjectURL(fileInput.files[0]);
      imgBlobs.push(imgUrl);
    }

    // DOM ìƒì„±
    const horseEl = document.createElement("div");
    horseEl.className = "horse";
    // íŠ¸ë™ ë‚´ ìˆ˜ì§ ìœ„ì¹˜: Flexë¡œ ë¶„ë°°í•˜ë˜, CSS topì€ ì‚¬ìš© ì•ˆí•¨ (Flex justify-content: space-evenly)
    // í•˜ì§€ë§Œ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ relative ì»¨í…Œì´ë„ˆ ì•ˆì— absoluteë¡œ ë°°ì¹˜í•˜ê±°ë‚˜, 
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ íŠ¸ë™ ì»¨í…Œì´ë„ˆê°€ flex-col ì´ë¯€ë¡œ, 
    // ê° ë§ì€ ë³„ë„ì˜ div(row) ì—†ì´ absolute top %ë¡œ ë°°ì¹˜í•˜ëŠ”ê²Œ ì• ë‹ˆë©”ì´ì…˜ ì œì–´ê°€ ì‰¬ì›€.
    
    // ìˆ˜ì •: íŠ¸ë™ ì˜ì—­ ë‚´ ììœ  ë°°ì¹˜ (yì¶•)
    const topPos = 15 + (idx * 22); // 15%, 37%, 59%, 81% ëŒ€ëµ ë°°ì¹˜
    horseEl.style.top = topPos + "%"; 

    if(imgUrl) {
      const img = document.createElement("img");
      img.src = imgUrl;
      img.className = "runner-img";
      horseEl.appendChild(img);
    } else {
      const emoji = document.createElement("div");
      emoji.className = "horse-emoji";
      emoji.textContent = "ğŸƒ";
      horseEl.appendChild(emoji);
    }

    tracksEl.appendChild(horseEl);

    // ëŸ¬ë„ˆ ê°ì²´
    horses.push({
      id: idx,
      name: name,
      el: horseEl,
      imgUrl: imgUrl,
      x: 0,
      finished: false,
      // ì†ë„ ê´€ë ¨ ì„¤ì • (ë§¤ìš° ëŠë¦¬ê²Œ ì¡°ì •ë¨)
      baseSpeed: 15 + Math.random() * 5, // ê¸°ì¡´ 60ì—ì„œ ëŒ€í­ í•˜í–¥ -> ì•½ 15~20í”½ì…€/sec ëŠë‚Œìœ¼ë¡œ ì‹œì‘í•´ì„œ ë°°ìˆ˜ë¡œ ëœ€
      
      // ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°ë“¤
      nextBoost: 0.2 + Math.random() * 0.6, // 20~80% êµ¬ê°„ ì–´ë”˜ê°€
      boostDuration: 0,
      isBoosting: false,
      
      nextInjury: 0.3 + Math.random() * 0.4,
      injuryDuration: 0,
      isInjured: false,

      nextBanana: 0.4 + Math.random() * 0.4,
      bananaUsed: false,
      
      isSlipping: false,
      slipDuration: 0,

      // ë§‰íŒ ìŠ¤í¼íŠ¸
      finalDrama: 0.85 + Math.random() * 0.05, 
      finalAction: Math.random() > 0.5 ? 'boost' : 'injury', 
      dramaUsed: false
    });
  });
}

// --- ë£¨í”„ ---
let lastTime = 0;
// íŠ¸ë™ ê¸¸ì´ ê³„ì‚° (í”¼ë‹ˆì‰¬ ë¼ì¸ ìœ„ì¹˜ ê³ ë ¤)
function getFinishX() { return document.getElementById("raceArea").clientWidth - 160; }

function loop(timestamp) {
  if(!raceRunning) return;
  if(!lastTime) lastTime = timestamp;
  const dt = timestamp - lastTime;
  lastTime = timestamp;

  const finishX = getFinishX();
  
  // ì „ì²´ ëŸ¬ë„ˆ ì¤‘ ì„ ë‘/í›„ë¯¸ ê±°ë¦¬ íŒŒì•… (ê³ ë¬´ì¤„)
  const xs = horses.map(h => h.x);
  const leaderX = Math.max(...xs);
  const lastX = Math.min(...xs);
  const dist = leaderX - lastX || 1;

  let allFinished = true;

  horses.forEach(h => {
    if(h.finished) return;
    allFinished = false;

    // ì§„í–‰ë¥  (0~1)
    const progress = h.x / finishX;
    
    // ê¸°ë³¸ ì†ë„ ê³„ì‚° (ì†ë„ ê³„ìˆ˜ ëŒ€í­ í•˜í–¥: * 0.6 -> * 0.08 ìˆ˜ì¤€ìœ¼ë¡œ ë‚®ì¶°ì•¼ 10ì´ˆ ì´ìƒ ê±¸ë¦¼)
    // ì›ë˜ ë¡œì§: (speed * delta) / 1000 * multiplier
    // ëª©í‘œ: 10ì´ˆ = 10000ms. 
    // 1000px ê°€ë ¤ë©´ 100px/s = 0.1px/ms.
    // baseSpeedê°€ 20ì´ë©´, multiplierê°€ 0.005 ì •ë„ì—¬ì•¼ í•¨.
    
    let currentSpeed = h.baseSpeed; // ì•½ 15~20

    // ê³ ë¬´ì¤„: ë’¤ì²˜ì§€ë©´ ë¹¨ë¼ì§
    const rankFactor = (leaderX - h.x) / dist; // 0(ì„ ë‘) ~ 1(ê¼´ì°Œ)
    currentSpeed += (rankFactor * 10); // ê¼´ì°ŒëŠ” ì†ë„ +10

    // ìƒíƒœ ì²˜ë¦¬
    if(h.isSlipping) {
      currentSpeed = -15; // ë’¤ë¡œ í›„í‡´
      h.slipDuration -= dt;
      if(h.slipDuration <= 0) { h.isSlipping = false; h.el.classList.remove("slipping"); }
    }
    else if(h.isInjured) {
      currentSpeed *= 0.2; // ë¶€ìƒ ì‹œ ë§¤ìš° ëŠë¦¼
      h.injuryDuration -= dt;
      if(h.injuryDuration <= 0) { h.isInjured = false; h.el.classList.remove("injured"); }
    }
    else if(h.isBoosting) {
      currentSpeed *= 4.0; // ë¶€ìŠ¤í„°
      h.boostDuration -= dt;
      if(h.boostDuration <= 0) { h.isBoosting = false; h.el.classList.remove("boosting"); }
    }
    else {
      // ì¼ë°˜ ì£¼í–‰ ì¤‘ ì´ë²¤íŠ¸ ì²´í¬
      
      // 1. ë°”ë‚˜ë‚˜ (ì•ì‚¬ëŒ ê³µê²©)
      if(!h.bananaUsed && progress > h.nextBanana) {
        h.bananaUsed = true;
        // ë‚˜ë³´ë‹¤ ì•ì— ìˆëŠ” ì‚¬ëŒ ì¤‘ í•œ ëª…
        const targets = horses.filter(t => !t.finished && t.x > h.x);
        if(targets.length > 0) {
          const victim = targets[Math.floor(Math.random()*targets.length)];
          victim.isSlipping = true;
          victim.slipDuration = 1000; // 1ì´ˆê°„ ë¯¸ë„ëŸ¬ì§
          victim.isBoosting = false; victim.el.classList.remove("boosting");
          victim.el.classList.add("slipping");
        }
      }

      // 2. ë¶€ìŠ¤í„°
      if(progress > h.nextBoost && progress < h.nextBoost + 0.1) {
        // ì¼íšŒì„± íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ ë²”ìœ„ë¥¼ ì§€ë‚˜ë©´ nextBoost ê°’ì„ 2ë¡œ ë³€ê²½í•´ë²„ë¦¼
        h.nextBoost = 2; 
        h.isBoosting = true;
        h.boostDuration = 1500; // 1.5ì´ˆ ë¶€ìŠ¤íŠ¸
        h.el.classList.add("boosting");
      }

      // 3. ë¶€ìƒ (ëœë¤)
      if(progress > h.nextInjury && progress < h.nextInjury + 0.1 && Math.random() < 0.02) {
        h.nextInjury = 2;
        h.isInjured = true;
        h.injuryDuration = 1200;
        h.el.classList.add("injured");
      }

      // 4. ë§‰íŒ ìŠ¤í¼íŠ¸/ì¢Œì ˆ
      if(!h.dramaUsed && progress > h.finalDrama) {
        h.dramaUsed = true;
        if(h.finalAction === 'boost') {
          h.isBoosting = true;
          h.boostDuration = 2500; // ê²°ìŠ¹ì„ ê¹Œì§€ ì­‰
          h.el.classList.add("boosting");
        } else {
          h.isInjured = true;
          h.injuryDuration = 1500;
          h.el.classList.add("injured");
        }
      }
    }

    // ì‹¤ì œ ì´ë™ ì ìš© (ì†ë„ ê³„ìˆ˜ ì¡°ì ˆ: 0.3)
    // dtëŠ” ì•½ 16ms. speedê°€ 20ì¼ ë•Œ -> 20 * 16 / 1000 * 0.3 ~= 0.1px/frame (ë„ˆë¬´ ëŠë¦¼)
    // 10ì´ˆ ëª©í‘œë©´ í”„ë ˆì„ë‹¹ ì•½ 1.6px (1000px ê¸°ì¤€)
    // speed 20 * 16 / 1000 * K = 1.6 -> K = 5.0 ì •ë„ í•„ìš”
    const move = (currentSpeed * dt) / 1000 * 3.5; 
    h.x += move;

    // ê²°ìŠ¹ì„  í†µê³¼
    if(h.x >= finishX) {
      h.x = finishX;
      h.finished = true;
      h.el.classList.remove("boosting", "injured", "slipping");
      finishedOrder.push(h);
      // ê²¹ì¹¨ ë°©ì§€ (ë„ì°© ìˆœì„œëŒ€ë¡œ ì•½ê°„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ)
      h.x += (FIXED_NAMES.length - finishedOrder.length) * 15;
    }

    h.el.style.transform = `translateX(${h.x}px)`;
  });

  if(finishedOrder.length === horses.length) {
    raceRunning = false;
    stopMusic();
    setTimeout(showResult, 1200);
  } else {
    animationFrameId = requestAnimationFrame(loop);
  }
}

function startRace() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  if(mode === 'match' && parseLines(prizeInput.value).length < 1) {
    alert("ìƒí’ˆ/ë²Œì¹™ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  // UI ì ê¸ˆ
  startBtn.disabled = true;
  resetBtn.disabled = true;
  document.querySelectorAll('input').forEach(i => i.disabled = true);
  document.getElementById("winnerOverlay").classList.add("hidden");

  playMusic();
  setupRace();
  
  raceRunning = true;
  lastTime = null;
  document.getElementById("raceStatus").textContent = "ğŸ”¥ ë ˆì´ìŠ¤ ì§„í–‰ ì¤‘! (ì•½ 15ì´ˆ ì†Œìš”)";
  
  requestAnimationFrame(loop);
}

function showResult() {
  const winner = finishedOrder[0];
  const mode = document.querySelector('input[name="mode"]:checked').value;
  let prizes = [];
  
  if(mode === 'match') {
    // ìƒí’ˆ ì„ê¸°
    const raw = parseLines(prizeInput.value);
    // ë„‰ë„‰íˆ ë³µì œ í›„ ì…”í”Œ
    let pool = [...raw, ...raw, ...raw];
    pool.sort(() => Math.random() - 0.5);
    prizes = pool;
  }

  document.getElementById("winnerName").textContent = `1ë“±: ${winner.name}`;
  const ph = document.getElementById("winnerPhoto");
  ph.innerHTML = "";
  if(winner.imgUrl) {
    const img = document.createElement("img");
    img.src = winner.imgUrl;
    ph.appendChild(img);
  } else {
    ph.innerHTML = "<span style='font-size:4rem'>ğŸ‰</span>";
  }

  const list = document.getElementById("rankList");
  list.innerHTML = "";
  
  let pIndex = 0;
  finishedOrder.forEach((h, idx) => {
    const row = document.createElement("div");
    row.className = "rank-row";
    
    // ìƒí’ˆ ë°°ì •
    let myPrize = "";
    if(mode === 'match') {
      let p1 = prizes[pIndex++] || "ì—†ìŒ";
      myPrize = p1;
      // ì‚¬ì—­ìº í¼ìŠ¤ íŠ¹ì „: 2ê°œ
      if(h.name === "ì‚¬ì—­ìº í¼ìŠ¤") {
        let p2 = prizes[pIndex++] || "ì—†ìŒ";
        myPrize = `1ï¸âƒ£ ${p1}, 2ï¸âƒ£ ${p2}`;
      }
    }

    row.innerHTML = `
      <div class="rank-left">
        <span class="rank-badge">${idx+1}ë“±</span>
        <span class="rank-txt">${h.name}</span>
      </div>
      <div class="rank-prize">${myPrize}</div>
    `;
    list.appendChild(row);
  });

  winnerOverlay.classList.remove("hidden");
  
  // UI ë³µêµ¬
  startBtn.disabled = false;
  resetBtn.disabled = false;
  document.querySelectorAll('input').forEach(i => i.disabled = false);
}

// ì´ë²¤íŠ¸
startBtn.addEventListener("click", startRace);
resetBtn.addEventListener("click", () => {
  stopMusic();
  raceRunning = false;
  cancelAnimationFrame(animationFrameId);
  setupRace(); // ë¦¬ì…‹ ì‹œ íŠ¸ë™ ì´ˆê¸°í™”
  document.getElementById("raceStatus").textContent = "ëŒ€ê¸° ì¤‘...";
});
document.getElementById("closeBtn").addEventListener("click", () => winnerOverlay.classList.add("hidden"));
document.getElementById("replayBtn").addEventListener("click", () => {
  winnerOverlay.classList.add("hidden");
  startRace();
});

// ì´ˆê¸° ë¡œë“œ ì‹œ ëŸ¬ë„ˆ ë°°ì¹˜ ë³´ì—¬ì£¼ê¸°
setupRace();

</script>
</body>
</html>
